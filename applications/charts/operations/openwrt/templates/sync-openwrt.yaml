apiVersion: batch/v1
kind: CronJob
metadata:
  name: sync-openwrt
  namespace: operations
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: sync-openwrt
              image: alpine:latest
              imagePullPolicy: IfNotPresent
              env:
                - name: FIREWALL_HOST
                  value: "gw.crazyzone.be"
                - name: FIREWALL_USER
                  value: "root"
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  # Make sure SSH client + scp are available
                  apk add --no-cache openssh-client

                  # Run the cert update script (from ConfigMap)
                  sh /openwrt-actions/cert_update

                  # Now run the package update script (from ConfigMap)
                  sh /openwrt-actions/package_update

                  echo "OpenWrt sync completed successfully."
              volumeMounts:
                - name: tls
                  mountPath: /certs
                  readOnly: true
                - name: ssh-key
                  mountPath: /ssh/id_ed25519
                  subPath: gateway-crazyzone-be-key
                  readOnly: true
                - name: openwrt-actions
                  mountPath: /openwrt-actions
                  readOnly: true
          volumes:
            - name: tls
              secret:
                secretName: crazyzone-be-tls
                defaultMode: 256
            - name: ssh-key
              secret:
                secretName: gateway-crazyzone-be-ssh
                defaultMode: 256
            - name: openwrt-actions
              configMap:
                name: openwrt-actions
