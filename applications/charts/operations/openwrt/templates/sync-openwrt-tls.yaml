apiVersion: batch/v1
kind: CronJob
metadata:
  name: sync-openwrt-tls
  namespace: operations
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: sync-openwrt-tls
              image: alpine:latest
              imagePullPolicy: IfNotPresent
              env:
                - name: FIREWALL_HOST
                  value: "gw.crazyzone.be"
                - name: FIREWALL_USER
                  value: "root"
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  sleep 3600
                  
                  if [ -z "$FIREWALL_HOST" ] || [ "$FIREWALL_HOST" = "REPLACE_WITH_FIREWALL_HOST" ]; then
                    echo "FIREWALL_HOST not configured" >&2
                    exit 1
                  fi

                  # Ensure ssh and scp is available
                  apk add --no-cache openssh-client

                  # Copy cert and key directly into /etc on the firewall
                  # -O = legacy SCP protocol (works with Dropbear, avoids SFTP)
                  scp -O -i /tmp/id_ed25519 -o StrictHostKeyChecking=no /certs/tls.crt "${FIREWALL_USER}@${FIREWALL_HOST}:/etc/uhttpd.crt"
                  scp -O -i /tmp/id_ed25519 -o StrictHostKeyChecking=no /certs/tls.key "${FIREWALL_USER}@${FIREWALL_HOST}:/etc/uhttpd.key"

                  # Fix permissions and reload uhttpd
                  ssh -i /tmp/id_ed25519 -o StrictHostKeyChecking=no "${FIREWALL_USER}@${FIREWALL_HOST}" 'chmod 600 /etc/uhttpd.crt /etc/uhttpd.key && /etc/init.d/uhttpd reload'
              volumeMounts:
                - name: tls
                  mountPath: /certs
                  readOnly: true
                - name: ssh-key
                  mountPath: /ssh/id_ed25519
                  subPath: gateway-crazyzone-be-key
                  readOnly: true
          volumes:
            - name: tls
              secret:
                secretName: crazyzone-be-tls
                defaultMode: 256
            - name: ssh-key
              secret:
                defaultMode: 256
                secretName: gateway-crazyzone-be-ssh
